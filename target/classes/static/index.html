<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestionnaire de Films à Voir</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container my-5">
    <h2 class="mb-4 text-center">Gestionnaire de Films à Voir</h2>

    <div class="card mb-4">
        <div class="card-header">Ajouter un film</div>
        <div class="card-body">
            <form id="taskForm">
                <div class="mb-3">
                    <label for="title" class="form-label">Titre</label>
                    <input type="text" id="title" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" class="form-control"></textarea>
                </div>
                <div class="mb-3">
                    <label for="priority" class="form-label">Priorité</label>
                    <select id="priority" class="form-select">
                        <option>URGENTE</option>
                        <option>NORMALE</option>
                        <option>FAIBLE</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="dueDate" class="form-label">Date limite</label>
                    <input type="date" id="dueDate" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Ajouter</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Liste des films</div>
        <ul id="taskList" class="list-group list-group-flush"></ul>
    </div>
</div>

<script>
    const API_URL = "http://localhost:9090/tasks";

    async function fetchTasks() {
        const response = await fetch(API_URL);
        const tasks = await response.json();
        const list = document.getElementById('taskList');
        list.innerHTML = "";
        tasks.forEach(task => {
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                        <h5>${task.title}</h5>
                        <p>${task.description || ''}</p>
                        <span class="badge bg-${priorityColor(task.priority)}">${task.priority}</span>
                        <span class="badge bg-${statusColor(task.status)}">${task.status.replace('_', ' ')}</span>
                        <small class="text-muted">Date limite : ${task.dueDate || 'Non précisée'}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-warning me-2" onclick="updateStatus(${task.id})">Changer statut</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})">Supprimer</button>
                    </div>
                </li>`;
        });
    }

    function priorityColor(priority) {
        return {
            URGENTE: 'danger',
            NORMALE: 'primary',
            FAIBLE: 'secondary'
        }[priority];
    }

    function statusColor(status) {
        return {
            A_REGARDER: 'warning',
            EN_COURS: 'info',
            TERMINEE: 'success'
        }[status];
    }

    async function deleteTask(id) {
        await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        fetchTasks();
    }

    async function updateStatus(id) {
        const newStatus = prompt("Nouveau statut (A_REGARDER, EN_COURS, TERMINEE) :");
        if (["A_REGARDER", "EN_COURS", "TERMINEE"].includes(newStatus)) {
            await fetch(`${API_URL}/${id}/status?status=${newStatus}`, { method: "PATCH" });
            fetchTasks();
        } else {
            alert("Statut invalide.");
        }
    }

    document.getElementById('taskForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const task = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            priority: document.getElementById('priority').value,
            dueDate: document.getElementById('dueDate').value
        };
        await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(task)
        });
        e.target.reset();
        fetchTasks();
    });

    fetchTasks();
</script>
</body>
</html>
